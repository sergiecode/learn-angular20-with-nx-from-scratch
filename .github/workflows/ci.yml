# ConfiguraciÃ³n de IntegraciÃ³n Continua (CI) para el proyecto
name: CI

# Define cuÃ¡ndo se ejecuta el workflow
on:
  push:
    branches:
      - master           # Se ejecuta cuando hay push a la rama master
      - tutorial/**      # Se ejecuta cuando hay push a cualquier rama que empiece con "tutorial/"
  pull_request:          # Se ejecuta en todos los pull requests

# Permisos mÃ­nimos requeridos para el workflow
permissions:
  actions: read          # Permiso para leer acciones de GitHub
  contents: read         # Permiso para leer el contenido del repositorio

jobs:
  main:
    runs-on: ubuntu-latest  # Ejecuta el job en un runner de Ubuntu
    steps:
      # Paso 1: Descarga el cÃ³digo del repositorio
      - uses: actions/checkout@v4
        with:
          filter: tree:0     # Descarga todos los archivos (incluye archivos grandes)
          fetch-depth: 0     # Descarga todo el historial de git (necesario para Nx)

      
      # Paso 2: DistribuciÃ³n de tareas con Nx Cloud (OPCIONAL - comentado)
      # Esto permite distribuir las tareas entre mÃºltiples agentes para acelerar el CI
      # Descomenta la siguiente lÃ­nea para habilitar la distribuciÃ³n de tareas
      # - run: npx nx start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

      
      # Paso 3: ConfiguraciÃ³n de Node.js con cachÃ©
      - uses: actions/setup-node@v4
        with:
          node-version: 20   # Usa Node.js versiÃ³n 20
          cache: 'npm'       # Habilita cachÃ© de npm para acelerar instalaciones
       
      # Paso 4: InstalaciÃ³n de dependencias
      - run: npm ci --legacy-peer-deps  # Instala dependencias de producciÃ³n (mÃ¡s rÃ¡pido que npm install)


      # Paso 5: EjecuciÃ³n de tareas de Nx (lint, test, build)
      # Opcional: Puedes grabar logs en Nx Cloud anteponiendo "npx nx-cloud record --"
      # - run: npx nx-cloud record -- echo Hello World
      - run: npx nx run-many -t lint test build  # Ejecuta linting, tests y build en todos los proyectos afectados
      
      # Paso 6: Auto-reparaciÃ³n de CI con Nx Cloud
      - run: npx nx fix-ci    # Intenta reparar automÃ¡ticamente problemas comunes de CI
        if: always()          # Se ejecuta siempre, incluso si pasos anteriores fallan

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OTRAS ACCIONES POPULARES QUE SE SUELEN AGREGAR EN GITHUB ACTIONS:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ğŸš€ DESPLIEGUE A AWS
# Despliega automÃ¡ticamente la aplicaciÃ³n a Amazon Web Services
# - run: aws s3 sync ./dist s3://mi-bucket --delete

# â˜ï¸ DESPLIEGUE A GOOGLE CLOUD PLATFORM
# Sube la aplicaciÃ³n a Google Cloud Platform
# - run: gcloud app deploy

# ğŸ³ DOCKER
# Construye y sube imagen Docker al registry
# - run: docker build -t mi-app . && docker push mi-app

# ğŸ“¦ PUBLICAR PAQUETE NPM
# Publica librerÃ­as a npm registry automÃ¡ticamente
# - run: npm publish

# ğŸ”’ ANÃLISIS DE SEGURIDAD
# Escanea vulnerabilidades en dependencias y cÃ³digo
# - run: npm audit --audit-level=high

# ğŸ“Š REPORTES DE COBERTURA
# Sube reportes de cobertura de tests a servicios como Codecov
# - uses: codecov/codecov-action@v3

# ğŸ’¬ NOTIFICACIONES
# EnvÃ­a notificaciones a Slack, Discord, email cuando falla/pasa el CI
# - uses: 8398a7/action-slack@v3

# ğŸŒ DESPLIEGUE A VERCEL/NETLIFY
# Despliega automÃ¡ticamente a plataformas de hosting
# - uses: amondnet/vercel-action@v25

# ğŸ·ï¸ RELEASE AUTOMÃTICO
# Crea releases y tags automÃ¡ticamente basado en commits
# - uses: semantic-release/semantic-release

# ğŸ§ª TESTS E2E
# Ejecuta tests de extremo a extremo con herramientas como Cypress
# - run: npx cypress run

# ğŸ“± TESTS EN MÃšLTIPLES NAVEGADORES
# Ejecuta tests en diferentes navegadores y sistemas operativos
# - uses: browser-actions/setup-chrome@latest

# ğŸ”„ CACHE AVANZADO
# Mejora velocidad guardando node_modules y builds anteriores
# - uses: actions/cache@v3